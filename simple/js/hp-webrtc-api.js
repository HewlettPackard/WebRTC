"use strict";function checkSingleton(){try{return coverage?void 0:window.WebRTCFactory}catch(e){return void 0}}function isWebRTCEnabled(){return void 0!==navigator&&"[object Navigator]"===Object.prototype.toString.call(navigator)&&void 0!==(navigator.mozGetUserMedia||navigator.webkitGetUserMedia)?!0:!1}if("undefined"!=typeof _&&"[object Function]"===Object.prototype.toString.call(_)&&console.log("Using lodash version : "+_.VERSION),"undefined"==typeof io||"[object Function]"!==Object.prototype.toString.call(io))throw"You need Javascript Socket.IO as component for the WebRTC Client";if(console.log("Using Socket.IO"),window.WebRTCFactory=checkSingleton()||function(){var e={};e.VERSION=[0,5,0].join(".");var t=1410965054;e.DATE=new Date(1e3*t).toString("dddd, MMMM ,yyyy"),e.SCOPE_GATEWAY="gateway",e.SCOPE_ROOM="room";var n=function(e,t){switch(e){case"SignalingChannel":Object.defineProperty(t,"STATE_SIGNALING_STALE",{value:"Stale",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"STATE_SIGNALING_NOT_CONNECTED",{value:"Not Connected",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"STATE_SIGNALING_CONNECTING",{value:"Connecting",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"STATE_SIGNALING_READY",{value:"Ready",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"STATE_SIGNALING_INCOMING_CALL",{value:"Incoming Call",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"STATE_SIGNALING_OUTGOING_CALL",{value:"Outgoing Call",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"STATE_SIGNALING_INCOMING_MESSAGE",{value:"Incoming Message",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"STATE_SIGNALING_INCOMING_MESSAGE_STATUS",{value:"Incoming Message Status",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"STATE_SIGNALING_OUTGOING_MESSAGE",{value:"Outgoing Message",enumerable:!1,configurable:!1,writable:!1}),t.state=t.STATE_SIGNALING_NOT_CONNECTED;break;case"FSM":Object.defineProperty(t,"FSM_IDLE",{value:"Idle",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"FSM_SIGCONNECTED",{value:"Sig Connected",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"FSM_MEDIA_READY",{value:"Media Ready",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"FSM_PEER_CREATED",{value:"Peer Created",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"FSM_ROOM_JOINED",{value:"Room Joined",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"FSM_ROOM_LEFT",{value:"Room Left",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"FSM_ERROR",{value:"Error",enumerable:!1,configurable:!1,writable:!1});break;case"Media":Object.defineProperty(t,"MEDIA_NONE",{value:"None",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"MEDIA_NEW_STREAM",{value:"New Stream",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"MEDIA_NEW_ATTACHED_STREAM",{value:"New Attached Stream",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"MEDIA_REMOVE_STREAM",{value:"Remove Stream",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"MEDIA_REMOVE_ATTACHED_STREAM",{value:"Remove Attached Stream",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"MEDIA_ERROR",{value:"Error",enumerable:!1,configurable:!1,writable:!1}),t.state=t.MEDIA_NONE;break;case"CallEventState":Object.defineProperty(t,"CALL_EVENT_NONE",{value:"NONE",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_EVENT_TRYING",{value:"TRYING",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_EVENT_RINGING",{value:"RINGING",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_EVENT_FORWARDING",{value:"FORWARDING",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_EVENT_QUEUED",{value:"QUEUED",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_EVENT_EARLY_ANSWERED",{value:"EARLY_ANSWERED",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_EVENT_EARLY_TERMINATED",{value:"EARLY_TERMINATED",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_EVENT_ANSWERED",{value:"ANSWERED",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_EVENT_HANGUP",{value:"HANGUP",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_EVENT_INCOMING_MESSAGE",{value:"Incoming Message",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_EVENT_INCOMING_MESSAGE_STATUS",{value:"Incoming Message Status",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_EVENT_OUTGOING_MESSAGE",{value:"Outgoing Message",enumerable:!1,configurable:!1,writable:!1}),t.state=t.CALL_EVENT_NONE;break;case"CallState":Object.defineProperty(t,"CALL_STATE_READY",{value:"Ready",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_STATE_ACTIVE",{value:"Active",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_STATE_ERROR",{value:"Error",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_STATE_HANGUP",{value:"Hangup",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_STATE_DESTROYED",{value:"Destroyed",enumerable:!1,configurable:!1,writable:!1});break;case"CallDirection":Object.defineProperty(t,"CALL_DIRECTION_INCOMING",{value:"Incoming",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_DIRECTION_OUTGOING",{value:"Outgoing",enumerable:!1,configurable:!1,writable:!1});break;case"CallErrorDetail":Object.defineProperty(t,"CALL_ERROR_DETAIL_TIMEOUT",{value:"TIMEOUT",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_ERROR_DETAIL_UNAVAILABLE",{value:"UNAVAILABLE",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_ERROR_DETAIL_BUSY",{value:"BUSY",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_ERROR_DETAIL_NO_ANSWER",{value:"NO_ANSWER",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_ERROR_DETAIL_NOT_REACHABLE",{value:"NOT_REACHABLE",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_ERROR_DETAIL_REJECTED",{value:"REJECTED",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_ERROR_DETAIL_INVALID_RESPONSE",{value:"INVALID_RESPONSE",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_ERROR_DETAIL_REDIRECTED",{value:"REDIRECTED",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_ERROR_DETAIL_BAD_REQUEST",{value:"BAD_REQUEST",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_ERROR_DETAIL_REMOTE_ERROR",{value:"REMOTE_ERROR",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_ERROR_DETAIL_GLOBAL_ERROR",{value:"GLOBAL_ERROR",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_ERROR_DETAIL_INTERNAL_ERROR",{value:"INTERNAL_ERROR",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_ERROR_DETAIL_MEDIA_ERROR",{value:"MEDIA_ERROR",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_ERROR_DETAIL_NOT_AUTHORIZED",{value:"NOT_AUTHORIZED",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_ERROR_DETAIL_AUTHORIZATION_FAILED",{value:"AUTHORIZATION_FAILED",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_ERROR_DETAIL_IO_ERROR",{value:"IO_ERROR",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_ERROR_DETAIL_TERMINATED",{value:"TERMINATED",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_ERROR_DETAIL_LIMIT_REACHED",{value:"LIMIT_REACHED",enumerable:!1,configurable:!1,writable:!1});break;case"Call":Object.defineProperty(t,"CALL_NONE",{value:1,enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_OUTGOING",{value:2,enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_INCOMING",{value:3,enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_INCOMING_NO_SDP",{value:4,enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_ERROR",{value:5,enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_HANGUP",{value:6,enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"CALL_DESTROYED",{value:7,enumerable:!1,configurable:!1,writable:!1}),t.callType=t.CALL_NONE;case"Session":Object.defineProperty(t,"SESSION_INITIAL",{value:"initial",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"SESSION_STABLE",{value:"stable",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"SESSION_HAVE_LOCAL_OFFER",{value:"have-local-offer",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"SESSION_HAVE_REMOTE_OFFER",{value:"have-remote-offer",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"SESSION_HAVE_LOCAL_PRANSWER",{value:"have-local-pranswer",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"SESSION_HAVE_REMOTE_PRANSWER",{value:"have-remote-pranswer",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"SESSION_CLOSED",{value:"closed",enumerable:!1,configurable:!1,writable:!1}),t.signalingState=t.SESSION_INITIAL;break;case"ICE":Object.defineProperty(t,"ICE_NEW",{value:"new",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"ICE_GATHERING",{value:"gathering",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"ICE_COMPLETE",{value:"complete",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"ICE_CHECKING",{value:"checking",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"ICE_CONNECTED",{value:"connected",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"ICE_COMPLETED",{value:"completed",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"ICE_FAILED",{value:"failed",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"ICE_DISCONNECTED",{value:"disconnected",enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(t,"ICE_CLOSED",{value:"closed",enumerable:!1,configurable:!1,writable:!1}),t.gatheringState=t.ICE_NEW,t.connectionState=t.ICE_NEW}return t};e.WebRTCEvent=function(e){Object.defineProperty(this,"name",{value:e||"event",enumerable:!0,configurable:!1,writable:!1}),Object.defineProperty(this,"stopPropagation",{value:!1,enumerable:!0,configurable:!1,writable:!0})},e.WebRTCSignalingChannelEvent=function(e,t){n("SignalingChannel",this),Object.defineProperty(this,"message",{value:t,enumerable:!0,configurable:!1,writable:!1}),Object.defineProperty(this,"state",{value:e,enumerable:!0,configurable:!1,writable:!1})},e.WebRTCSignalingChannelEvent.prototype=new e.WebRTCEvent("signaling"),e.WebRTCSignalingChannelEvent.prototype.constructor=e.WebRTCSignalingChannelEvent,e.WebRTCMediaEvent=function(e,t){n("Media",this),Object.defineProperty(this,"message",{value:t,enumerable:!0,configurable:!1,writable:!1}),Object.defineProperty(this,"state",{value:e,enumerable:!0,configurable:!1,writable:!1})},e.WebRTCMediaEvent.prototype=new e.WebRTCEvent("media"),e.WebRTCMediaEvent.prototype.constructor=e.WebRTCMediaEvent,e.WebRTCICEEvent=function(e,t,i){n("ICE",this),Object.defineProperty(this,"gatheringState",{value:e,enumerable:!0,configurable:!1,writable:!1}),Object.defineProperty(this,"connectionState",{value:t,enumerable:!0,configurable:!1,writable:!1}),i&&Object.defineProperty(this,"event",{value:{type:"ice-offer",label:i.candidate.sdpMLineIndex,id:i.candidate.sdpMid,candidate:i.candidate.candidate},enumerable:!0,configurable:!1,writable:!1})},e.WebRTCICEEvent.prototype=new e.WebRTCEvent("ice"),e.WebRTCICEEvent.prototype.constructor=e.WebRTCICEEvent,e.WebRTCInternalCallEvent=function(e,t){Object.defineProperty(this,"cid",{value:e,enumerable:!0,configurable:!1,writable:!1}),Object.defineProperty(this,"message",{value:t,enumerable:!0,configurable:!1,writable:!1})},e.WebRTCInternalCallEvent.prototype=new e.WebRTCEvent("internal-call"),e.WebRTCInternalCallEvent.prototype.constructor=e.WebRTCInternalCallEvent,e.WebRTCRoomJoinedEvent=function(e,t){Object.defineProperty(this,"room",{value:e,enumerable:!0,configurable:!1,writable:!1}),Object.defineProperty(this,"message",{value:t,enumerable:!0,configurable:!1,writable:!1})},e.WebRTCRoomJoinedEvent.prototype=new e.WebRTCEvent("joined"),e.WebRTCRoomJoinedEvent.prototype.constructor=e.WebRTCRoomJoinedEvent,e.WebRTCRoomLeftEvent=function(e,t){Object.defineProperty(this,"room",{value:e,enumerable:!0,configurable:!1,writable:!1}),Object.defineProperty(this,"message",{value:t,enumerable:!0,configurable:!1,writable:!1})},e.WebRTCRoomLeftEvent.prototype=new e.WebRTCEvent("left"),e.WebRTCRoomLeftEvent.prototype.constructor=e.WebRTCRoomLeftEvent,e.WebRTCCallEvent=function(e,t){n("CallEventState",this),Object.defineProperty(this,"message",{value:t,enumerable:!0,configurable:!1,writable:!1}),Object.defineProperty(this,"state",{value:e,enumerable:!0,configurable:!1,writable:!1})},e.WebRTCCallEvent.prototype=new e.WebRTCEvent("call"),e.WebRTCCallEvent.prototype.constructor=e.WebRTCCallEvent,e.WebRTCSessionEvent=function(e){n("Session",this),this.signalingState=e},e.WebRTCSessionEvent.prototype=new e.WebRTCEvent("session"),e.WebRTCSessionEvent.prototype.constructor=e.WebRTCSessionEvent;var i=n("Session",{});e.WebRTCError=function(e,t){Object.defineProperty(this,"name",{value:"error",enumerable:!0,configurable:!1,writable:!1}),Object.defineProperty(this,"message",{value:e||"",enumerable:!0,configurable:!1,writable:!1}),Object.defineProperty(this,"stopPropagation",{value:!1,enumerable:!0,configurable:!1,writable:!0}),t?(n("CallErrorDetail",this),Object.defineProperty(this,"detail",{value:t,enumerable:!0,configurable:!1,writable:!0}),console.error("WebRTCError: "+e+": "+JSON.stringify(t,null,4))):console.error("WebRTCError: "+e)},e.WebRTCError.prototype=new Error,e.WebRTCError.prototype.constructor=e.WebRTCError;var r=function(e){var t={},n=function(e,t){return e===t||_.isFunction(e.listener)&&e.listener===t},i={on:function(n,i,r){if(!_.isString(n))throw new TypeError("types must be a string");if(!_.isFunction(i))throw new TypeError("listener must be a function");if(void 0===r)r="common";else if(!_.isString(r))throw new TypeError("id must be a string");var a=n.toLowerCase().split(/\s+/),o=t[r];return o||(o=t[r]={}),a.forEach(function(e){o[e]?_.isArray(o[e])?o[e].push(i):o[e]=[o[e],i]:o[e]=i}),e},once:function(t,n,i){function r(){this.off(t,r,i),n.apply(e,arguments)}if(!_.isString(t))throw new TypeError("type must be a string");if(!_.isFunction(n))throw new TypeError("listener must be a function");if(void 0===i)i="common";else if(!_.isString(i))throw new TypeError("cid must be a string");return t=t.toLowerCase(),r.listener=n,this.on(t,r,i)},off:function(i,r,a){if(!_.isFunction(r))throw new TypeError("listener must be a function");if(!_.isString(i))throw new TypeError("types must be a string");if(void 0===a)a="common";else if(!_.isString(a))throw new TypeError("cid must be a string");var o=t[a];if(!o)return e;var l=i.toLowerCase().split(/\s+/);return l.forEach(function(t){var i,a,l;if(i=o[t],a=-1,n(i,r))return delete o[t],e;if(_.isArray(i)){for(l=i.length;l-->0;)if(n(i[l],r)){a=l;break}if(0>a)return e;1===i.length?delete o[t]:i.splice(a,1)}return e}),_.isEmpty(o)&&delete t[a],e},_removeAllListeners:function(e,n){void 0===n&&(n="common");var i=t[n];if(i)return void 0===e?void delete t[n]:void(_.isString(e)&&(e=e.toLowerCase(),i[e]&&delete i[e],0===i.length&&delete t[n]))},countListeners:function(e,n){void 0===n&&(n="common");var i=t[n];if(!i)return 0;var r=0;if(void 0===e){for(var a in t)r+=this.countListeners(a,n);return r}return _.isString(e)?(e=e.toLowerCase(),i[e]?_.isArray(i[e])?i[e].length:1:0):0},_emit:function(n,i,r){if(void 0===r&&(r="common"),"signaling"===i.name&&(r="common"),"error"===n&&0===this.countListeners(n,r))throw i;var a=t[r];if(!a)return!1;var o=a[n];if(!o)return!1;if(_.isFunction(o))return o.call(e,i),!0;if(_.isArray(o)){for(var l=0;l<o.length;l++)o[l].call(e,i);return!0}return!1},_postEvent:function(e,t,n){e.stopPropagation!==!0&&this._emit(e.name,e,n),void 0!==t&&t(e),e.stopPropagation!==!0&&this._emit("event",e,n)},_postError:function(e,t,n){void 0!==t&&t(e),e.stopPropagation!==!0&&this._emit("error",e,n)},_exports:function(){return{on:i.on,once:i.once,off:i.off,countListeners:i.countListeners}}};return i};return e.createConnectivity=function(t){if(!isWebRTCEnabled())throw"Your browser does not support webRTC";return new function(){var a={};a.getDateTime=function(e,t){var n=new Date,i=n.getHours();i=(10>i?"0":"")+i;var r=n.getMinutes();r=(10>r?"0":"")+r;var a=n.getSeconds();a=(10>a?"0":"")+a;var o=n.getMilliseconds();o=(10>o?"00":100>o?"0":"")+o;var l=n.getFullYear(),s=n.getMonth()+1;s=(10>s?"0":"")+s;var c=n.getDate();return c=(10>c?"0":"")+c,(void 0===e?"":e)+l+"/"+s+"/"+c+" "+i+":"+r+":"+a+"-"+o+(void 0===t?"":t)};var o={global:{verbose:"localStorage"in window&&null!==window.localStorage&&localStorage.debug&&-1!=localStorage.debug.indexOf("com.hp.webrtc.api")},fsm:{useTimeout:!0,timeout:25e3},security:{ck:void 0,ckInMessage:!1},signalingChannel:{uris:[],transports:["websocket"],heartbeats:!0,reconnectionAttempts:5,reconnectionDelay:2e3,reconnectionDelayMax:2e3,timeout:2e4,pongTimeout:3e4},rtcConfiguration:{iceServers:[]}},l=_.cloneDeep(o);if(l=_.merge(l,t),!l.ck)throw new e.WebRTCError("You must provide a valid Channel Key");if(l.security.ck=l.ck,delete l.ck,!l.gwUris)throw new e.WebRTCError("You must provide a valid gateway URIs list");l.signalingChannel.uris=_.cloneDeep(l.gwUris),delete l.gwUris;var s=r(a);_.extend(a,s._exports());var c={},d={},u={generateCid:function(e){var t=[];e&&_.isString(e)&&0===e.indexOf("room:")&&t.push("room:");var n=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)},i=function(){var e=(1e12+13*(new Date).getTime()).toString(16);return e.substring(e.length-12)};return t.push(n()),t.push(n()),t.push("-"),t.push(n()),t.push("-"),t.push(n()),t.push("-"),t.push(n()),t.push("-"),t.push(i()),t.join("")},setUris:function(t){var n;if(_.isString(t))n=[t];else{if(!_.isArray(t)||0===t.length)throw new e.WebRTCError("No uri to connect to. Please retry later.");n=t}var i=[];n.some(function(t,n){try{var r=document.createElement("a");switch(r.href=t,i[n]={uri:t,protocol:r.protocol,hostname:r.hostname,port:r.port,pathname:r.pathname,host:r.host},i[n].protocol){case"http:":i[n].secured=!1;break;case"https:":i[n].secured=!0;break;case"ws:":i[n].secured=!1;break;case"wss:":i[n].secured=!0;break;default:throw new e.WebRTCError("Invalid uri schema passed")}l.global.verbose&&console.log("uri["+n+"]: "+t)}catch(a){throw new e.WebRTCError("Invalid uri format passed")}}),this.config.expandedUris=i,this.config.currentUriIndex=0},handleConnEvent:function(t,n,i){try{s._postEvent(t,n,i)}catch(r){u.handleConnError(new e.WebRTCError("Exception in connectivity event processing",r))}},handleConnError:function(e,t,n){try{s._postError(e,t,n)}catch(i){console.error("Exception in connectivity error event processing: "+JSON.stringify(i,null,4))}},create:function(t){if(l.global.verbose&&console.log("Enter : createSignalingChannel"),t&&!_.isPlainObject(t))throw new e.WebRTCError("The first parameter of SignalingChannel.create must be an object");var n=this;if(this.config=_.merge(l.signalingChannel,t),this.config.address)throw new e.WebRTCError("The address parameter is not anymore supported, please use gwUris");this.setUris(this.config.uris),this.active!==!0&&(this.initialized!==!0&&(this.onConnect=function(){l.global.verbose&&console.log(a.getDateTime("[","] ")+"Signaling Channel Connect received"),n.signalingChannel.io.attempts=0,n.state=n.STATE_SIGNALING_READY,console.log("Connected to uri: "+n.config.url),u.handleConnEvent(new e.WebRTCSignalingChannelEvent(n.state,"Connected to : "+n.config.url)),n.clientConnected||(u.postMessage(e.SCOPE_GATEWAY,u.prepareMessage(l.security,{type:"connect",userAgent:navigator.userAgent})),n.clientConnected=!0),n.pingTimerId=setTimeout(function(){n.sendPing(n)},l.signalingChannel.pongTimeout)},this.onDisconnect=function(t){l.global.verbose&&console.log(a.getDateTime("[","] ")+"Signaling Channel Disconnect received"+(n.onErrorStatusCode>0?" following error "+n.onErrorStatusCode:"")+"\n"+t),console.log("Disconnected from uri: "+n.config.url),n.stopPingTimer(n);var i=n.state;if(n.state=n.STATE_SIGNALING_NOT_CONNECTED,n.cleanupSocket(n.signalingChannel),n.signalingChannel=void 0,"io client disconnect"===t){delete n.clientConnected;for(var r in c){var o=c[r];void 0!==o&&o.destroy()}for(var s in d){var E=d[s];void 0!==E&&E.destroy()}i==n.STATE_SIGNALING_READY&&u.handleConnEvent(new e.WebRTCSignalingChannelEvent(n.state,"Client disconnected from : "+n.config.url))}else"io server disconnect"===t?n.onErrorStatusCode>=500?(i==n.STATE_SIGNALING_READY&&u.handleConnEvent(new e.WebRTCSignalingChannelEvent(n.state,"Temporarily disconnected from : "+n.config.url)),setTimeout(function(){n.connectSocket(!0)},n.config.reconnectionDelay)):n.onErrorStatusCode>=400?(n.state=n.STATE_SIGNALING_STALE,u.handleConnEvent(new e.WebRTCSignalingChannelEvent(n.state,"Definitely disconnected from : "+n.config.url))):(delete n.clientConnected,i==n.STATE_SIGNALING_READY&&u.handleConnEvent(new e.WebRTCSignalingChannelEvent(n.state,"Server disconnected from : "+n.config.url))):(i==n.STATE_SIGNALING_READY&&u.handleConnEvent(new e.WebRTCSignalingChannelEvent(n.state,"Unexpectedly disconnected from : "+n.config.url)),setTimeout(function(){n.connectSocket()},n.config.reconnectionDelay));n.onErrorStatusCode=0},this.onError=function(t){n.onErrorStatusCode=0;var i;void 0!==t&&_.isString(t)&&(i=parseInt(t.substring(0,3))),void 0===i||isNaN(i)?(console.log(a.getDateTime("[","] ")+"Signaling Channel Error received without status code:\n"+JSON.stringify(t,null,4)),u.handleConnError(new e.WebRTCError("Signaling Channel Error",t))):(l.global.verbose&&console.log(a.getDateTime("[","] ")+"Signaling Channel Error received with status code: "+i+"\n"+JSON.stringify(t,null,4)),n.onErrorStatusCode=i)},this.onConnectError=function(){l.global.verbose&&console.log(a.getDateTime("[","] ")+"Signaling Channel Connect Error received: attempt "+this.io.attempts)},this.onReconnectError=function(){l.global.verbose&&console.log(a.getDateTime("[","] ")+"Signaling Channel Reconnect Error received: attempt "+this.io.attempts),this.io.attempts>n.config.reconnectionAttempts&&n.connectSocket(!0)},this.onMessage=function(t){if(t.handled=!1,l.global.verbose&&console.log(a.getDateTime("[","] ")+"Signaling Channel Message received:\n"+JSON.stringify(t,null,4)),t.body&&t.body.type){var i,r=t.cid||t.body.cid||t.room;switch(t.handled=!0,t.body.type){case"pong":if(n.pingTimerId&&clearTimeout(n.pingTimerId),void 0!==t.body.gwUris)try{u.setUris(t.body.gwUris)}catch(o){console.warn("Invalid gwUris received in pong message: "+o.message)}n.pingTimerId=setTimeout(function(){n.sendPing(n)},1e3*t.body.timeout);break;case"progress":i=new e.WebRTCCallEvent(t.body.code,"Remotely");break;case"error":if(void 0===r){var E=parseInt(t.body.code.substring(0,3));isNaN(E)||403!=E?i=new e.WebRTCError(t.body.message||"Connectivity Server Error",t.body.code):n.onErrorStatusCode=E}else i=new e.WebRTCError(t.body.message||"Call Error",t.body.code);break;case"offer-request":case"offer":var C=t.body.ood;if(c[t.cid]){console.warn("Reinviting call not yet supported. Ignored");break}if(console.log("Incoming call"),0!==s.countListeners("signaling")||0!==s.countListeners("event")){var g={signalingState:n.STATE_SIGNALING_INCOMING_CALL};g.sdp=t.body.sdp,g.security={cid:t.cid,tid:t.tid},a.createCall(C,g)}else console.warn("Incoming call rejected because there is no event listener registered"),u.postMessage(e.SCOPE_GATEWAY,{ck:l.security.ckInMessage?l.security.ck:void 0,cid:t.cid,tid:t.tid,type:"signaling",body:{type:"error",code:"NO_ANSWER"}});break;case"answer":i=new e.WebRTCInternalCallEvent(t.cid,t.body);break;case"ice-offer":break;case"hangup":i=new e.WebRTCCallEvent("HANGUP","Remotely");break;case"im":console.log("Incoming message");var b={ood:t.body.ood,msgId:t.cid+"-"+t.tid,profile:t.body.profile,payload:t.body.payload},f=c[t.cid];void 0!==f?i=new e.WebRTCCallEvent(u.STATE_SIGNALING_INCOMING_MESSAGE,b):(r=void 0,i=new e.WebRTCSignalingChannelEvent(u.STATE_SIGNALING_INCOMING_MESSAGE,b));var h;0!==s.countListeners("signaling")||0!==s.countListeners("event")?void 0===f?h="SUCCESS":0!==f.countListeners("call")||0!==f.countListeners("event")?h="SUCCESS":(console.warn("Incoming message rejected because there is no event listener registered on the call"),i=void 0,h="NO_ANSWER"):(console.warn("Incoming message rejected because there is no event listener registered on the connectivity"),i=void 0,h="NO_ANSWER"),void 0!==h&&u.postMessage(e.SCOPE_GATEWAY,{type:"signaling",ck:l.security.ckInMessage?l.security.ck:void 0,cid:t.cid,tid:t.tid,body:{scope:t.body.scope,type:"im-status",code:h}});break;case"im-status":var m={msgId:t.cid+"-"+t.tid,code:t.body.code};c[t.cid]?i=new e.WebRTCCallEvent(u.STATE_SIGNALING_INCOMING_MESSAGE_STATUS,m):(r=void 0,i=new e.WebRTCSignalingChannelEvent(u.STATE_SIGNALING_INCOMING_MESSAGE_STATUS,m));break;case"joined":i=new e.WebRTCRoomJoinedEvent(t.room,t.body);break;case"left":i=new e.WebRTCRoomLeftEvent(t.room,t.body);break;default:t.handled=!1}if(void 0!==i)if("joined"===i.name||"left"===i.name){var S=d[i.room];S?i.stopPropagation!==!0&&S._handleRoomEvent(i,void 0,i.room):(i=new e.WebRTCError("No active Room found",404),u.handleConnEvent(i,void 0,i.room))}else u.handleConnEvent(i,void 0,r);else t.handled===!1&&console.warn("Unknown message type : "+t.body.type)}else console.log("Dropping message...")},this.connectSocket=function(t){if(this.active===!0&&(void 0===this.signalingChannel||!this.signalingChannel.connected)){void 0!==this.signalingChannel&&(this.state=n.STATE_SIGNALING_NOT_CONNECTED,this.cleanupSocket(this.signalingChannel),this.signalingChannel=void 0),t&&(this.config.currentUriIndex++,this.config.currentUriIndex>=this.config.expandedUris.length&&(this.config.currentUriIndex=0));var i=this.config.expandedUris[this.config.currentUriIndex].uri+"/signaling";console.log("Connecting to uri["+this.config.currentUriIndex+"]: "+i),(this.state!=this.STATE_SIGNALING_CONNECTING||this.config.url!==i)&&(this.state=this.STATE_SIGNALING_CONNECTING,this.config.url=i,u.handleConnEvent(new e.WebRTCSignalingChannelEvent(this.state,"Connecting to : "+this.config.url))),this.signalingChannel=io.connect(this.config.url,{host:this.config.expandedUris[this.config.currentUriIndex].hostname,transports:this.config.transports,heartbeats:this.config.heartbeats,forceNew:!0,query:"ck="+l.security.ck,autoConnect:!0,reconnection:!0,reconnectionAttempts:this.config.reconnectionAttempts,reconnectionDelay:this.config.reconnectionDelay,reconnectionDelayMax:this.config.reconnectionDelayMax,timeout:this.config.timeout}),this.signalingChannel.on("connect",this.onConnect),this.signalingChannel.on("disconnect",this.onDisconnect),this.signalingChannel.on("error",this.onError),this.signalingChannel.on("reconnect_error",this.onReconnectError),this.signalingChannel.on("message",this.onMessage)}},this.cleanupSocket=function(e){e.io.reconnection(!1),e.io.close(),e.io.destroy(),e.destroy()},this.initialized=!0),this.active=!0,this.connectSocket())},destroy:function(){l.global.verbose&&console.log("Enter : destroySignalingChannel"),this.active===!0?(this.active=!1,void 0!==this.signalingChannel?(this.signalingChannel.connected&&u.postMessage(e.SCOPE_GATEWAY,u.prepareMessage(l.security,{type:"disconnect"})),this.signalingChannel.disconnect()):this.state=this.STATE_SIGNALING_NOT_CONNECTED):this.state=this.STATE_SIGNALING_NOT_CONNECTED},isReady:function(){return this.state===this.STATE_SIGNALING_READY},prepareMessage:function(e,t,n){var i={ck:e.ckInMessage?e.ck:void 0,cid:e.cid,tid:e.tid,type:"signaling",body:t};return n&&(i=_.merge(i,n)),i},postMessage:function(t,n){l.global.verbose&&console.log("Enter : postSignalingMessage"),void 0!==this.signalingChannel&&this.signalingChannel.connected?(this.signalingChannel.emit(t,n),l.global.verbose&&console.log("Signaling Channel Message Sent:\n"+JSON.stringify(n,null,4))):u.handleConnError(new e.WebRTCError("Invalid Signaling Channel"))},sendPing:function(t){u.postMessage(e.SCOPE_GATEWAY,u.prepareMessage(l.security,{type:"ping"})),t.pingTimerId=setTimeout(function(){t.sendPing(t)},l.signalingChannel.pongTimeout)},stopPingTimer:function(e){void 0!==e.pingTimerId&&(clearTimeout(e.pingTimerId),e.pingTimerId=void 0)}};return n("SignalingChannel",u),a.getCalls=function(){return c},a.getRooms=function(){return d},a.sendMessage=function(t,n,i){var r,a={type:"im",scope:"GLOBAL",ood:_.isString(n)?n:JSON.stringify(n),profile:i,payload:_.isString(t)?t:JSON.stringify(t)};return a=u.prepareMessage(l.security,a),a.cid=u.generateCid(n),a.tid="i0",u.postMessage(e.SCOPE_GATEWAY,a),r=a.cid+"-"+a.tid,u.handleConnEvent(new e.WebRTCSignalingChannelEvent(u.STATE_SIGNALING_OUTGOING_MESSAGE,{ood:a.body.ood,msgId:r,profile:i,payload:a.body.payload})),r},a.connect=function(){u.create()},a.disconnect=function(){u.destroy()},a.newRoom=function(t,i){return new function(){var o={},s=(_.cloneDeep(i),_.cloneDeep(l));o.id=t.substring("room:".length),o.security={},o.security.ck=s.security.ck;var c=r(o),E={fsmSigConnected:function(e){if(s.global.verbose&&console.log("Execute action associated with state transition to SigConnected"),u.isReady())e.onNext();else{var t=function(i){i.state===i.STATE_SIGNALING_READY&&(a.off("signaling",t),a.off("error",n),e.onNext())},n=function(i){a.off("signaling",t),a.off("error",n),e.onError(i)};a.on("signaling",t),a.on("error",n),a.connect()}},fsmRoomJoin:function(){s.global.verbose&&console.log("Execute action associated with state transition to SigConnected");var t=u.prepareMessage(o.security,{type:"join"},{type:"room",room:o.id});u.postMessage(e.SCOPE_ROOM,t)},fsmRoomLeave:function(){s.global.verbose&&console.log("Execute action associated with state transition to SigConnected");var t=u.prepareMessage(o.security,{type:"leave"},{type:"room",room:o.id});u.postMessage(e.SCOPE_ROOM,t)}};return o.FSM={_initialize:function(t,n,i){return _.isPlainObject(t)&&_.isArray(t.stateTransitions)&&0!==t.stateTransitions.length?(t.cbEvent=n,t.cbError=i,t.current=0,t.isValidState=function(e){return _.isArray(e)?-1!=e.indexOf(o.FSM.state):e===o.FSM.state},t.executeAction=function(){this.isValidState(this.stateTransitions[this.current].from)?this.stateTransitions[this.current].action?(this.enableTimer(),this.stateTransitions[this.current].action(this)):console.warn("No action associated to "+this.stateTransitions[this.current].from):o._handleRoomError(new e.WebRTCError("FSM invalid state : "+o.FSM.state+" but in "+this.stateTransitions[this.current].from),i)},t.onNext=function(){this.disableTimer(),o.FSM.state=this.stateTransitions[this.current].to,this.current+1<this.stateTransitions.length&&(this.current++,this.executeAction())},t.onError=function(t){this.disableTimer(),o._handleRoomError(new e.WebRTCError(t),i)},t.start=function(){if(this.isValidState(this.stateTransitions[this.current].from))this.executeAction();else{var t=this.stateTransitions[this.current].from;this.current=void 0;for(var n=0;n<this.stateTransitions.length;n++)if(this.isValidState(this.stateTransitions[n].from)){this.current=n;break}this.current?this.executeAction():o._handleRoomError(new e.WebRTCError("FSM invalid state : "+o.FSM.state+" but in "+t),i)}},t.enableTimer=function(){if(void 0!==this.timerId)o._handleRoomError(new e.WebRTCError("A FSM timer is already in place"),this.cbError);else if(s.fsm.useTimeout===!0){var t=this;this.timerId=setTimeout(function(){o._handleRoomError(new e.WebRTCError("A timeout has occured during "+t.stateTransitions[t.current].from+" operation"),t.cbError)
},s.fsm.timeout||5e3)}},t.disableTimer=function(){s.global.verbose&&console.log("Disabling timer : "+this.timerId),void 0!==this.timerId&&(clearTimeout(this.timerId),this.timerId=void 0)}):t.start=function(){o._handleRoomError(new e.WebRTCError("FSM object creation - invalid arguments"),i)},t},join:function(e,t){s.global.verbose&&console.log("Enter : FSM.place : function(cbEvent, cbError)");var n={arguments:{},stateTransitions:[{action:E.fsmSigConnected,from:this.FSM_IDLE,to:this.FSM_SIGCONNECTED},{action:E.fsmRoomJoin,from:this.FSM_SIGCONNECTED,to:this.FSM_ROOM_JOINED}]};o.FSM._initialize(n,e,t).start()},leave:function(e,t){this.state=o.FSM.FSM_IDLE,this.current=0;var n={arguments:{},stateTransitions:[{action:E.fsmSigConnected,from:this.FSM_IDLE,to:this.FSM_SIGCONNECTED},{action:E.fsmRoomLeave,from:this.FSM_SIGCONNECTED,to:this.FSM_ROOM_LEFT}]};o.FSM._initialize(n,e,t).start()}},n("FSM",o.FSM),o.FSM.state=o.FSM.FSM_IDLE,o._handleRoomEvent=function(t,n,i){try{c._postEvent(t,n,i)}catch(r){o._handleCallError(new e.WebRTCError("Exception in call event processing",r))}},o._handleRoomError=function(e,t,n){c._postError(e,t,n)},o.on=function(e,t){c.on(e,t,o.id)},o.off=function(e,t){c.off(e,t,o.id)},o.join=function(){o.FSM.join()},o.leave=function(){o.FSM.leave()},o.destroy=function(){d[o.id]&&delete d[o.id]},o.on("left",function(){o.destroy()},o.id),d[o.id]=o,o}},a.createCall=function(t,o){return new function(){var d={},E=_.isString(t)?t:JSON.stringify(t),C={localVideoEl:void 0,inCallLocalVideoEl:void 0,remoteVideoEl:void 0,signalingState:u.STATE_SIGNALING_OUTGOING_CALL,mediaStreamConstraints:{audio:!0,video:!0,data:void 0},cseq:0},g=_.cloneDeep(l);g=_.merge(g,C),d.security={},d.security.ck=g.security.ck,d.security.ckInMessage=g.security.ckInMessage,void 0!==o.security&&(void 0!==o.security.cid&&(d.security.cid=o.security.cid,delete o.security.cid),void 0!==o.security.tid&&(d.security.tid=o.security.tid,delete o.security.tid),delete o.security),g=_.merge(g,o),void 0===d.security.cid&&(d.security.cid=u.generateCid(t)),void 0===d.security.tid&&(d.security.tid="i"+g.cseq++);var b=r(d);_.extend(d,b._exports());var f=function(){var t={};if(navigator.mozGetUserMedia)try{t.getUserMedia=navigator.mozGetUserMedia.bind(navigator),t.RTCPeerConnection=mozRTCPeerConnection,t.RTCSessionDescription=mozRTCSessionDescription,t.RTCIceCandidate=mozRTCIceCandidate,t.getPeerStats=function(e,t,n){n("Not Yet implemmented")}}catch(n){throw new e.WebRTCError("Your browser does not fully support webRTC : "+n)}else{if(!navigator.webkitGetUserMedia)throw new e.WebRTCError("Your browser does not support webRTC");try{t.getUserMedia=navigator.webkitGetUserMedia.bind(navigator),t.RTCPeerConnection=webkitRTCPeerConnection,t.RTCSessionDescription=RTCSessionDescription,t.RTCIceCandidate=RTCIceCandidate,t.getPeerStats=function(e,t,n){e.getStats(function(e){var n=[];e.result().forEach(function(e){var t={};e.names().forEach(function(n){t[n]=e.stat(n)}),t.id=e.id,t.type=e.type,t.timestamp=e.timestamp,n.push(t)}),t(n)},n)}}catch(n){throw new e.WebRTCError("Your browser does not fully support webRTC : "+n)}}return t}(),h={fsmSigConnected:function(e){if(g.global.verbose&&console.log("Execute action associated with state transition to SigConnected"),u.isReady())e.onNext();else{var t=function(i){i.state===i.STATE_SIGNALING_READY&&(a.off("signaling",t),a.off("error",n),e.onNext())},n=function(i){a.off("signaling",t),a.off("error",n),e.onError(i)};a.on("signaling",t),a.on("error",n),a.connect()}},fsmPeerCreated:function(e){g.global.verbose&&console.log("Execute action associated with state transition to PeerCreated"),g.sdp?d.Media.createPeer(g.rtcConfiguration,e.cbEvent,e.cbError)&&d.Media.setRemoteDescription({type:"offer",sdp:g.sdp}):(a.once("internal-call",function(e){e.stopPropagation=!0,"answer"===e.message.type&&d.Media.setRemoteDescription(e.message)},d.security.cid),d.Media.createPeer(g.rtcConfiguration,e.cbEvent,e.cbError)),e.onNext()}};return d.FSM={_initialize:function(t,n,i){return _.isPlainObject(t)&&_.isArray(t.stateTransitions)&&0!==t.stateTransitions.length?(t.cbEvent=n,t.cbError=i,t.current=0,t.isValidState=function(e){return _.isArray(e)?-1!=e.indexOf(d.FSM.state):e===d.FSM.state},t.executeAction=function(){this.isValidState(this.stateTransitions[this.current].from)?this.stateTransitions[this.current].action?(this.enableTimer(),this.stateTransitions[this.current].action(this)):console.warn("No action associated to "+this.stateTransitions[this.current].from):d.Call.handleCallError(new e.WebRTCError("FSM invalid state : "+d.FSM.state+" but in "+this.stateTransitions[this.current].from),i)},t.onNext=function(){this.disableTimer(),d.FSM.state=this.stateTransitions[this.current].to,this.current+1<this.stateTransitions.length&&(this.current++,this.executeAction())},t.onError=function(t){this.disableTimer(),d.Call.handleCallError(new e.WebRTCError(t),i)},t.start=function(){if(this.isValidState(this.stateTransitions[this.current].from))this.executeAction();else{var t=this.stateTransitions[this.current].from;this.current=void 0;for(var n=0;n<this.stateTransitions.length;n++)if(this.isValidState(this.stateTransitions[n].from)){this.current=n;break}this.current?this.executeAction():d.Call.handleCallError(new e.WebRTCError("FSM invalid state : "+d.FSM.state+" but in "+t),i)}},t.enableTimer=function(){if(void 0!==this.timerId)d.Call.handleCallError(new e.WebRTCError("A FSM timer is already in place"),this.cbError);else if(g.fsm.useTimeout===!0){var t=this;this.timerId=setTimeout(function(){d.Call.handleCallError(new e.WebRTCError("A timeout has occured during "+t.stateTransitions[t.current].from+" operation"),t.cbError)},g.fsm.timeout||5e3)}},t.disableTimer=function(){g.global.verbose&&console.log("Disabling timer : "+this.timerId),void 0!==this.timerId&&(clearTimeout(this.timerId),this.timerId=void 0)}):t.start=function(){d.Call.handleCallError(new e.WebRTCError("FSM object creation - invalid arguments"),i)},t},place:function(e,t){g.global.verbose&&console.log("Enter : FSM.place : function(cbEvent, cbError)");var n={arguments:{},stateTransitions:[{action:h.fsmSigConnected,from:this.FSM_IDLE,to:this.FSM_SIGCONNECTED},{action:h.fsmPeerCreated,from:this.FSM_SIGCONNECTED,to:this.FSM_PEER_CREATED}]};d.FSM._initialize(n,e,t).start()},answerNoSDP:function(e,t){g.global.verbose&&console.log("Enter : FSM.answerNoSDP : function(cbEvent, cbError)");var n={arguments:{},stateTransitions:[{action:h.fsmSigConnected,from:this.FSM_IDLE,to:this.FSM_SIGCONNECTED},{action:h.fsmPeerCreated,from:this.FSM_SIGCONNECTED,to:this.FSM_PEER_CREATED}]};d.FSM._initialize(n,e,t).start()},answerSDP:function(e,t){g.global.verbose&&console.log("Enter : FSM.answerSDP : function(cbEvent, cbError)");var n={arguments:{},stateTransitions:[{action:h.fsmPeerCreated,from:this.FSM_IDLE,to:this.FSM_PEER_CREATED}]};d.FSM._initialize(n,e,t).start()},destroy:function(){this.state=d.FSM.FSM_IDLE,this.current=0}},n("FSM",d.FSM),d.FSM.state=d.FSM.FSM_IDLE,d.ICE={add:function(e){if(g.global.verbose&&console.log("Enter : addIceEntry"),_.isArray(e))e.some(function(e){g.rtcConfiguration.iceServers.push(e)});else{if(!_.isPlainObject(e))throw"createIceEntry takes an array or plain object - See : http://dev.w3.org/2011/webrtc/editor/webrtc.html#idl-def-RTCConfiguration";g.rtcConfiguration.iceServers.push(e)}},get:function(){return g.global.verbose&&console.log("Enter : ICE.get"),{iceServers:g.rtcConfiguration.iceServers}},destroy:function(){g.global.verbose&&console.log("Enter : ICE.destroy"),g.rtcConfiguration.iceServers.length=0}},n("ICE",d.ICE),d.Media={localStream:void 0,remoteStream:void 0,peer:void 0,iceCandidates:[],createMediaStream:function(t,n,i){function r(t){o.state=o.MEDIA_NEW_STREAM,o.localStream=t,d.Call.handleCallEvent(new e.WebRTCMediaEvent(o.state,{type:"local",stream:t}),function(t){t.state===t.MEDIA_NEW_ATTACHED_STREAM||t.state===t.MEDIA_NEW_STREAM?n(t):d.Call.handleCallError(new e.WebRTCError("no media stream"),i)})}function a(e){g.global.verbose&&console.log("gotStream : stream");for(var n in t)g.hasOwnProperty(n)&&(g[n]=t[n]);g.mediaStreamConstraints.audio=t.audio,g.mediaStreamConstraints.video=t.video,r(e)}if(g.global.verbose&&console.log("Enter : createMediaStream"),!t||!_.isPlainObject(t))throw new e.WebRTCError("The first parameter of Media.createMediaStream must be an object");var o=this;f.getUserMedia(t,a,function(t){g.global.verbose&&console.log("getUserMedia : Stream error"),o.state=o.MEDIA_ERROR,d.Call.handleCallError(new e.WebRTCError(t.message||t),i)})},destroy:function(){var t;if(this.peer){if(void 0!==this.localStream)try{this.peer.removeStream(this.localStream)}catch(n){}if(void 0!==this.remoteStream)try{this.peer.removeStream(this.remoteStream)}catch(n){}this.peer.onnegotiationneeded=null,this.peer.onicecandidate=null,this.peer.onsignalingstatechange=null,this.peer.onaddstream=null,this.peer.onremovestream=null,this.peer.oniceconnectionstatechange=null,"closed"!==this.peer.signalingState&&this.peer.close()}if(this.localStream){t={type:"local",stream:this.localStream},d.Call.handleCallEvent(new e.WebRTCMediaEvent(this.MEDIA_REMOVE_STREAM,t));try{this.localStream.stop()}catch(n){}this.localStream=null,this.localStream=void 0}if(this.remoteStream){t={type:"remote",stream:this.remoteStream},d.Call.handleCallEvent(new e.WebRTCMediaEvent(this.MEDIA_REMOVE_STREAM,t));try{this.remoteStream.stop()}catch(n){}this.remoteStream=null,this.remoteStream=void 0}d.Media.state=d.Media.MEDIA_NONE},stats:function(t){if(t)if(d.Media.peer)try{f.getPeerStats(d.Media.peer,t,function(n){t(new e.WebRTCError("Failed to get stats from peer",n))})}catch(n){t(new e.WebRTCError("Failed to get stats from peer: "+n.message,n.stack))}else t([])},createPeer:function(t,n,i){g.global.verbose&&console.log("Enter : createPeer");var r=this;try{d.Media.peer=new f.RTCPeerConnection(t);var a=d.Media.peer;if(void 0!==a){if(g.mediaStreamConstraints.data){var o=a.createDataChannel(g.mediaStreamConstraints.data,{reliable:!0});o.onmessage=function(e){var t=e.data;console.log("I got data channel message: ",t)},o.onopen=function(){o.send("Hello World!")}}this.peer.onnegotiationneeded=function(){},this.peer.onicecandidate=function(t){t.candidate?(d.ICE.gatheringState=a.iceGatheringState,d.ICE.connectionState=a.iceConnectionState,d.Call.handleCallEvent(new e.WebRTCICEEvent(a.iceGatheringState,a.iceConnectionState,t),n)):(d.Call.handleCallEvent(new e.WebRTCICEEvent(a.iceGatheringState,a.iceConnectionState),n),d.ICE.gatheringState=a.iceGatheringState,d.ICE.connectionState=a.iceConnectionState,a.remoteDescription?a.iceGatheringState===d.ICE.ICE_COMPLETE&&u.postMessage(e.SCOPE_GATEWAY,u.prepareMessage(d.security,{type:"answer",sdp:a.localDescription.sdp})):a.iceGatheringState===d.ICE.ICE_COMPLETE&&(u.postMessage(e.SCOPE_GATEWAY,u.prepareMessage(d.security,{type:"offer",scope:d.Call.callType===d.Call.CALL_INCOMING_NO_SDP?"CALL":"GLOBAL",ood:E,sdp:a.localDescription.sdp})),d.Call.existsOnNetwork=!0))},this.peer.oniceconnectionstatechange=function(){d.Media.peer?(d.ICE.connectionState=d.Media.peer.iceConnectionState,d.Call.handleCallEvent(new e.WebRTCICEEvent(d.ICE.gatheringState,d.ICE.connectionState),n)):console.warn("Unhandled oniceconnectionstatechange - Revisit")},this.peer.onsignalingstatechange=function(){d.Call.signalingState=r.peer.signalingState,d.Call.handleCallEvent(new e.WebRTCSessionEvent(d.Call.signalingState),n)},this.peer.onaddstream=function(t){r.remoteStream=t.stream,d.Call.handleCallEvent(new e.WebRTCMediaEvent(r.MEDIA_NEW_STREAM,{type:"remote",stream:t.stream}))},this.peer.onremovestream=function(){console.warn("onremovestream - Add handler")},(d.Call.isOutgoing()||d.Call.isIncomingNoSDP())&&d.Media.createMediaStream(g.mediaStreamConstraints,function(){r.peer.addStream(d.Media.localStream),r.peer.createOffer(function(e){r.setLocalDescription(e)},function(t){d.Call.handleCallError(new e.WebRTCError(t),i)})})}return a}catch(l){d.Call.handleCallError(new e.WebRTCError(l.message||l),i)}return void 0},createAnswer:function(){var t=this;this.peer?d.Media.createMediaStream(g.mediaStreamConstraints,function(){t.peer.addStream(d.Media.localStream),t.peer.createAnswer(function(e){for(t.setLocalDescription(e);t.iceCandidates.length>0;){var n=t.iceCandidates.pop(),i=new f.RTCSessionDescription({sdpMLineIndex:n.label,candidate:n.candidate});t.peer.addIceCandidate(i)}},function(t){d.Call.handleCallError(new e.WebRTCError(t.message||t))})}):d.Call.handleCallError(new e.WebRTCError("peer is undefined"))},setLocalDescription:function(e){if(!d.Media.peer)throw"No peer defined...";d.Media.peer.setLocalDescription(e)},setRemoteDescription:function(t){if(d.Media.peer||this.createPeer(d.ICE.get()),d.Media.peer){var n=!this.peer.localDescription;this.peer.setRemoteDescription(new f.RTCSessionDescription(t),function(){n&&d.Call.handleAlerting()},function(t){console.error("setRemoteDescription: MEDIA ERROR: "+(t.message||t)),d.Call.handleCallError(new e.WebRTCError("Call Error","MEDIA_ERROR")),n&&(d.destroy(),u.handleConnError(new e.WebRTCError("Incoming Call with MEDIA_ERROR",d)))})}},manageVideoAttachmentsBeforePostEvent:function(t){if("media"===t.name)if(t.state===this.MEDIA_NEW_STREAM){if("local"===t.message.type){var n=g.localVideoEl;if(void 0!==this.remoteStream&&g.inCallLocalVideoEl&&(n=g.inCallLocalVideoEl),n){var i=document.getElementById(n);null!=i&&(this.attachedLocalVideoEl=n,t=new e.WebRTCMediaEvent(this.MEDIA_NEW_ATTACHED_STREAM,t.message),t.message.videoEl=n,i.src=window.URL.createObjectURL(t.message.stream),i.play())}}else if("remote"===t.message.type){var r=g.remoteVideoEl,a=document.getElementById(r);if(r&&null!=a&&(this.attachedRemoteVideoEl=r,t=new e.WebRTCMediaEvent(this.MEDIA_NEW_ATTACHED_STREAM,t.message),t.message.videoEl=r,a.src=window.URL.createObjectURL(t.message.stream),a.play()),void 0!==this.localStream){var n=g.localVideoEl;g.inCallLocalVideoEl&&(n=g.inCallLocalVideoEl),n&&(this.attachedLocalVideoEl?this.attachedLocalVideoEl!==n&&(d.Call.handleCallEvent(new e.WebRTCMediaEvent(this.MEDIA_REMOVE_STREAM,{type:"local",stream:this.localStream})),d.Call.handleCallEvent(new e.WebRTCMediaEvent(this.MEDIA_NEW_STREAM,{type:"local",stream:this.localStream}))):d.Call.handleCallEvent(new e.WebRTCMediaEvent(this.MEDIA_NEW_STREAM,{type:"local",stream:this.localStream})))}}}else t.state===this.MEDIA_REMOVE_STREAM&&("local"===t.message.type?void 0!==this.attachedLocalVideoEl&&(t=new e.WebRTCMediaEvent(this.MEDIA_REMOVE_ATTACHED_STREAM,t.message),t.message.videoEl=this.attachedLocalVideoEl):"remote"===t.message.type&&void 0!==this.attachedRemoteVideoEl&&(t=new e.WebRTCMediaEvent(this.MEDIA_REMOVE_ATTACHED_STREAM,t.message),t.message.videoEl=this.attachedRemoteVideoEl));return t},manageVideoAttachmentsAfterPostEvent:function(e){if("media"===e.name&&e.state===this.MEDIA_REMOVE_ATTACHED_STREAM)if("local"===e.message.type&&e.message.videoEl===this.attachedLocalVideoEl){if(this.attachedLocalVideoEl){var t=document.getElementById(this.attachedLocalVideoEl);this.attachedLocalVideoEl=void 0,t&&(t.src=null)}}else if("remote"===e.message.type&&e.message.videoEl===this.attachedRemoteVideoEl&&this.attachedRemoteVideoEl){var n=document.getElementById(this.attachedRemoteVideoEl);this.attachedRemoteVideoEl=void 0,n&&(n.src=null)}},isAttached:function(){return d.Media.state===d.Media.MEDIA_NEW_STREAM||d.Media.state===d.Media.MEDIA_NEW_ATTACHED_STREAM},addIceCandidate:function(e){if(this.peer){var t=new f.RTCIceCandidate({sdpMLineIndex:e.label,candidate:e.candidate});this.peer.addIceCandidate(t)}else this.iceCandidates.push(e)}},n("Media",d.Media),d.Call={getId:function(){return d.security.cid},getStats:function(e){d.Media.stats(e)},getConnectivity:function(){return d.Call.callType!==d.Call.CALL_DESTROYED?a:void 0},getOod:function(){return E},getDirection:function(){return g.signalingState===u.STATE_SIGNALING_INCOMING_CALL?d.CALL_DIRECTION_INCOMING:d.CALL_DIRECTION_OUTGOING},getState:function(){switch(d.Call.callType){case d.Call.CALL_NONE:return d.CALL_STATE_READY;case d.Call.CALL_OUTGOING:case d.Call.CALL_INCOMING:case d.Call.CALL_INCOMING_NO_SDP:return d.CALL_STATE_ACTIVE;case d.Call.CALL_ERROR:return d.CALL_STATE_ERROR;case d.Call.CALL_HANGUP:return d.CALL_STATE_HANGUP;case d.Call.CALL_DESTROYED:return d.CALL_STATE_DESTROYED;default:return void 0}},place:function(){if(!d.Call.isNotInitialized())throw new e.WebRTCError("call.place: Invalid call state, call already initialized");d.Call.callType=d.Call.CALL_OUTGOING,d.FSM.place()},pickup:function(t){if(!d.Call.isIncoming())throw new e.WebRTCError("call.pickup: Invalid call state, not in incoming call state");g=_.merge(g,t),d.Call.handleCallEvent(new e.WebRTCCallEvent("ANSWERED","Locally")),d.Call.postOnlyCallEvent=!1,d.Call.flushCallEvents(),d.Call.isIncomingNoSDP()?d.FSM.answerNoSDP():d.Media.createAnswer()},hangup:function(){d.Call.handleHangup(new e.WebRTCCallEvent("HANGUP","Locally"))},refuse:function(){if(!d.Call.isIncoming())throw new e.WebRTCError("call.refuse: Invalid call state, not in incoming call state");d.hangup()},destroy:function(){c[d.security.cid]&&(delete c[d.security.cid],this.hangup(),delete d.security.cid),d.Call.callType=d.Call.CALL_DESTROYED},isNotInitialized:function(){return d.Call.callType===d.Call.CALL_NONE},isOutgoing:function(){return d.Call.callType===d.Call.CALL_OUTGOING},isIncoming:function(){return d.Call.callType===d.Call.CALL_INCOMING||d.Call.callType===d.Call.CALL_INCOMING_NO_SDP},isIncomingNoSDP:function(){return d.Call.callType===d.Call.CALL_INCOMING_NO_SDP},hasLocalOffer:function(){return d.Call.signalingState===this.SESSION_HAVE_LOCAL_OFFER},hasRemoteOffer:function(){return d.Call.signalingState===this.SESSION_HAVE_REMOTE_OFFER},sendDtmf:function(t){if(!d.Call.isIncoming()&&!d.Call.isOutgoing())throw new e.WebRTCError("call.sendDtmf: Invalid call state, call is not active");var n={type:"dtmf",keys:t};n=u.prepareMessage(d.security,n),n.tid="i"+g.cseq++,u.postMessage(e.SCOPE_GATEWAY,n)},sendMessage:function(t,n,i){var r;if(!d.Call.isIncoming()&&!d.Call.isOutgoing())throw new e.WebRTCError("call.sendMessage: Invalid call state, call is not active");var a={type:"im",scope:"CALL",ood:_.isString(n)?n:JSON.stringify(n),profile:i,payload:_.isString(t)?t:JSON.stringify(t)};return a=u.prepareMessage(d.security,a),a.tid="i"+g.cseq++,u.postMessage(e.SCOPE_GATEWAY,a),r=a.cid+"-"+a.tid,d.Call.handleCallEvent(new e.WebRTCCallEvent(u.STATE_SIGNALING_OUTGOING_MESSAGE,{ood:a.body.ood,msgId:r,profile:i,payload:a.body.payload})),r},cleanUp:function(){var e=d.security.cid;d.Call.destroy(),d.Media.destroy(),d.FSM.destroy(),d.ICE.destroy(),b._removeAllListeners(),s._removeAllListeners(void 0,e)},handleAlerting:function(){d.Call.isIncoming()&&d.Call.existsOnNetwork&&u.postMessage(e.SCOPE_GATEWAY,u.prepareMessage(d.security,{type:"progress",code:"RINGING"})),d.Call.existsOnApplication=!0,d.Call.postOnlyCallEvent=d.Call.isIncoming(),u.handleConnEvent(new e.WebRTCSignalingChannelEvent(g.signalingState,d),void 0,d.security.cid),d.Call.flushCallEvents()},handleHangup:function(t){d.Call.callType!=d.Call.CALL_NONE&&d.Call.callType!=d.Call.CALL_ERROR&&d.Call.callType!=d.Call.CALL_HANGUP&&d.Call.callType!=d.Call.CALL_DESTROYED&&(u.isReady()&&d.Call.existsOnNetwork&&(u.postMessage(e.SCOPE_GATEWAY,u.prepareMessage(d.security,{type:"hangup"})),d.Call.existsOnNetwork=!1),d.Call.callType=d.Call.CALL_HANGUP,d.Call.existsOnApplication&&(d.Call.signalingState!==i.SESSION_INITIAL&&(d.Call.signalingState=i.SESSION_CLOSED,d.Call.handleCallEvent(new e.WebRTCSessionEvent(i.SESSION_CLOSED))),d.Call.handleCallEvent(t)),d.Call.cleanUp())},flushCallEvents:function(){if(void 0!==d.Call._delayedEvents){var e=d.Call._delayedEvents;d.Call._delayedEvents=void 0,e.forEach(function(e){d.Call.handleCallEvent(e)})}},handleCallEvent:function(t,n){if(!d.Call.existsOnApplication||d.Call.postOnlyCallEvent&&"call"!==t.name)void 0===d.Call._delayedEvents&&(d.Call._delayedEvents=[]),d.Call._delayedEvents.push(t),void 0!==n&&n(t);else{t=d.Media.manageVideoAttachmentsBeforePostEvent(t);try{b._postEvent(t,n)}catch(i){d.Call.handleCallError(new e.WebRTCError("Exception in call event processing",i))}d.Media.manageVideoAttachmentsAfterPostEvent(t)}},handleCallError:function(t,n){var r=!1;if(d.Call.callType!=d.Call.CALL_ERROR&&d.Call.callType!=d.Call.CALL_HANGUP&&d.Call.callType!=d.Call.CALL_DESTROYED){if(d.Call.callType!=d.Call.CALL_NONE&&u.isReady()&&d.Call.existsOnNetwork){var a;"Call Error"===t.message&&(a=t.detail),_.isString(a)||(a="INTERNAL_ERROR"),u.postMessage(e.SCOPE_GATEWAY,u.prepareMessage(d.security,{type:"error",code:a})),d.Call.existsOnNetwork=!1}d.Call.callType=d.Call.CALL_ERROR,r=!0}if(d.Call.existsOnApplication){try{b._postError(t,n)}catch(o){u.handleConnError(new e.WebRTCError("Exception in call error event processing",o))}d.Call.signalingState!==i.SESSION_INITIAL&&(d.Call.signalingState=i.SESSION_CLOSED,d.Call.handleCallEvent(new e.WebRTCSessionEvent(i.SESSION_CLOSED)))}r&&d.Call.cleanUp()},_exports:function(){return{getId:d.Call.getId,getStats:d.Call.getStats,getConnectivity:d.Call.getConnectivity,getOod:d.Call.getOod,getDirection:d.Call.getDirection,getState:d.Call.getState,place:d.Call.place,pickup:d.Call.pickup,hangup:d.Call.hangup,destroy:d.Call.destroy,refuse:d.Call.refuse,sendDtmf:d.Call.sendDtmf,sendMessage:d.Call.sendMessage}}},_.extend(d,d.Call._exports()),n("Call",d.Call),n("CallDirection",d),n("CallState",d),a.on("call",function(e){"HANGUP"===e.state?(d.Call.existsOnNetwork=!1,d.Call.handleHangup(e)):d.Call.handleCallEvent(e)},d.security.cid),a.on("error",function(e){d.Call.existsOnNetwork=!1,d.Call.handleCallError(e)},d.security.cid),g.signalingState===u.STATE_SIGNALING_INCOMING_CALL?(d.Call.callType=o.sdp?d.Call.CALL_INCOMING:d.Call.CALL_INCOMING_NO_SDP,d.Call.existsOnNetwork=!0):d.Call.existsOnNetwork=!1,c[d.security.cid]=d,d.Call.existsOnApplication=!1,d.Call.postOnlyCallEvent=!0,d.Call.isIncomingNoSDP()||d.Call.isNotInitialized()?d.Call.handleAlerting():d.FSM.answerSDP(),d}},a}},e}(),"undefined"==typeof window||"undefined"==typeof window.WebRTCFactory)throw"WebRTC Client failed to load...";console.log("Using WebRTC Factory  : "+window.WebRTCFactory.VERSION+" ("+window.WebRTCFactory.DATE+")");
//# sourceMappingURL=hp-webrtc-api.map.js